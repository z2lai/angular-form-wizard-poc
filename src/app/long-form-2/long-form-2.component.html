<h2 class="display-6">
  <b>Long Form 2 - Custom Validation Behaviour</b>
</h2>

<form
  [formGroup]="form"
  (ngSubmit)="onSubmit(form)"
  class="mt-5 border border-5 pt-3 pb-3 container needs-validation"
  [ngClass]="{
    'border-danger': form.touched && !form.valid,
    'border-success': form.touched && form.valid
  }"
  novalidate
>
  <div class="text-secondary">
    <b>Form Status:</b>
    <span
      [ngClass]="{
        'text-danger': form.touched && !form.valid,
        'text-success': form.touched && form.valid
      }"
    >
      <!-- All value and validation statuses are updated when the form is created -->
      {{ form.status }}
    </span>

    {{ form.touched ? 'touched' : 'untouched' }}
    {{ form.dirty ? 'dirty' : 'pristine' }}
    <button
      type="button"
      (click)="onMarkAllAsTouched(form)"
      class="btn btn-primary"
    >
      Mark All Touched
    </button>
    <br />
    <b>Form Value: </b>
    <!-- The following causes ExpressionChangedAfterItHasBeenCheckedError since child component modifies parent's state with setControl -->
    {{ form.value | json }}
    <!-- Note that even though a form group aggregates validity status of all child AbstractControls, it does not aggregate their errors. It only shows errors defined at its own form group level -->
    @if (!form.valid) {<br /><b>Form Errors: </b> {{ form.errors | json }}}
  </div>

  <!-- <app-text-field-cva formControlName="testInput"></app-text-field-cva> -->

  <ng-container formArrayName="issues">
    <ng-container *ngFor="let issueForm of issues.controls; let i = index">
      <form
        class="mt-3 border border-3 pt-3 pb-3 container"
        [formGroup]="issueForm"
        (ngSubmit)="onSubmit(issueForm)"
        [ngClass]="{
          'border-danger': issueForm.touched && !issueForm.valid,
          'border-success': issueForm.touched && issueForm.valid
        }"
      >
        <header class="row">
          <h3 style="height: 47px" class="display-6">
            Issue {{ i + 1 }}
            @if (issueForm.pending) {
              <div class="ms-3 spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            } @else if (
              issueForm.get('eligibilityValidators')?.touched &&
              issueForm.get('eligibilityValidators')?.valid 
            ) {
              <span class="badge bg-success ms-3">Eligible</span>
            } @else if (
              issueForm.get('eligibilityValidators')?.touched &&
              !issueForm.get('eligibilityValidators')?.valid 
            ) {
              <span class="badge bg-danger ms-3">Ineligible</span>
            }
          </h3>
          <div class="text-secondary">
            <b>Issue Status:</b>
            <span
              [ngClass]="{
                'text-danger': issueForm.touched && !issueForm.valid,
                'text-success': issueForm.touched && issueForm.valid
              }"
            >
              <!-- All value and validation statuses are updated when the issueForm is created -->
              {{ issueForm.status }}
            </span>
            {{ issueForm.touched ? 'touched' : 'untouched' }}
            {{ issueForm.dirty ? 'dirty' : 'pristine' }}
            <button
              type="button"
              (click)="onMarkAllAsTouched(issueForm)"
              class="btn btn-primary"
            >
              Mark All Touched
            </button>
            <br />
            <b>Issue Value: </b>
            <!-- The following causes ExpressionChangedAfterItHasBeenCheckedError since child component modifies parent's state with setControl -->
            {{ issueForm.value | json }}
            <!-- Note that even though a issueForm group aggregates validity status of all child AbstractControls, it does not aggregate their errors. It only shows errors defined at its own form group level -->
            @if (!issueForm.get('eligibilityValidators')?.valid) {
              <br /><b>Eligibility Check Errors:</b><br />{{ issueForm.get('eligibilityValidators')?.errors | json }}
            }
          </div>
        </header>

        <div class="row mt-3">
          <app-text-field-cva formControlName="issueType"></app-text-field-cva>
          <div
            [ngClass]="
              issueForm.get('eligibilityValidators')?.touched &&
              !issueForm.get('eligibilityValidators')?.valid 
                ? 'visible' 
                : 'invisible'
            "
            class="text-danger"
          >
            @if (issueForm.get('eligibilityValidators')?.hasError('issueType')) {
              <span>{{ issueForm.get('eligibilityValidators')?.getError('issueType') }}</span>
            } 
            @else if (issueForm.get('eligibilityValidators')?.hasError('issueEligibility')) {
              <span>
                {{issueForm.get('eligibilityValidators')?.getError('issueEligibility')}}
              </span>
            } 
            @else {
              <span class="invisible">placeholder</span>
            }
          </div>
          <div>
            <button
              type="button"
              style="width: 136px"
              class="btn btn-primary mt-3"
              (click)="onCheckEligibility(issueForm)"
            >
              @if (issueForm.pending) {
                <div
                  class="spinner-border spinner-border-sm text-light"
                  role="status"
                >
                  <span class="visually-hidden">Loading...</span>
                </div>
              } 
              @else { 
                <span>Check Eligibility</span> 
              }
            </button>
          </div>
          <!-- <div
            [ngClass]="
              issueForm.touched && !issueForm.valid ? 'visible' : 'invisible'
            "
            class="text-danger"
          >
            @if ( issueForm.hasError('issueType') ) {
            {{ issueForm.getError('issueType') }}
            } @else if ( issueForm.hasError('issueEligibility') ) {
            {{ issueForm.getError('issueEligibility') }}
            } @else {
            <span class="invisible">placeholder</span>
            }
          </div> -->
        </div>

        <!-- <section>
          <h6 class="display-6">Eligibility Questions</h6>
          <app-profile controlKey="eligibility"></app-profile>
        </section> -->
      </form>
    </ng-container>
  </ng-container>

  <div class="d-flex justify-content-between">
    <button type="button" class="btn btn-light mt-3" (click)="addIssue()">
      Add Issue
    </button>
    <button type="submit" style="width: 90px" class="btn btn-primary mt-3">
      @if (form.pending) {
      <div class="spinner-border spinner-border-sm text-light" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      } @else { Continue }
    </button>
  </div>
</form>

<section class="mt-5 container">
  <h3>Notes</h3>
  <p>
    In this version, the backend validation (async) of each Issue sub form is separated out into a manual button click,
    instead of triggering onBlur together with the frontend validation (sync) on the input.
    How can we display to the user the different UI states for each of these actions?
  </p>
  <p>
    <b>UI States and State Transitions</b>:
  </p>
  <ol>
    <li>
      <b>Initial State</b>: UI state starts out with an empty form with no status.
    </li>
    <li>
      <b>Initial State -> Input Changed:</b>
      When input is changed (and blurred), frontend validation is triggered and the input displays Valid status.
    </li>
    <li>
      <b>Input Changed -> Check Eligibility Clicked:</b>
      When Check Eligibility button is clicked, backend validation is triggered and form displays Eligibility status.
      <br>
      <b>Initial State -> Check Eligibility Clicked:</b>
      If done from the initial state, this also triggers the frontend validation and displays valid status on the input if not already done.
    </li>
    <li>
      <b>Check Eligibility Clicked -> Input Changed:</b>
      Then, if the input is changed again after Check Eligibility button is clicked, ...
    </li>
  </ol>
</section>
